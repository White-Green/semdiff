<style>
  .image-detail {
    display: grid;
    gap: 1rem;
    width: 100%;
  }

  .image-detail-tabs {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .image-detail-tab {
    border: 1px solid var(--diff-border);
    background: var(--diff-header-bg);
    color: var(--color-text);
    border-radius: 999px;
    padding: 0.35rem 0.85rem;
    cursor: pointer;
    font-size: 0.85rem;
  }

  .image-detail-tab[aria-selected="true"] {
    background: var(--diff-added-bg);
    border-color: var(--diff-added-border, var(--diff-border));
    font-weight: 600;
  }

  .image-detail-view {
    display: none;
  }

  .image-detail-view.active {
    display: block;
  }

  .image-detail-grid {
    display: grid;
    gap: 1rem;
  }

  .image-detail-grid.diff {
    grid-template-columns: repeat(3, minmax(0, 1fr));
  }

  .image-detail-grid.side {
    grid-template-columns: minmax(0, 1fr);
  }

  .image-detail-grid.single {
    grid-template-columns: minmax(0, 1fr);
  }

  .image-detail-card {
    border: 1px solid var(--diff-border);
    border-radius: 0.375rem;
    padding: 0.75rem;
    background: var(--diff-same-bg);
    display: grid;
    gap: 0.5rem;
  }

  .image-card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.5rem;
  }

  .image-detail-card h4 {
    margin: 0;
    font-size: 0.95rem;
    color: var(--color-text);
  }

  .image-detail-card span {
    font-size: 0.85rem;
    color: var(--color-muted);
  }

  .image-detail-card img {
    max-width: 100%;
    height: auto;
    border-radius: 0.25rem;
    background: var(--diff-empty-bg);
  }

  .image-side-compare {
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 0.75rem;
    align-items: start;
  }

  .image-side-item {
    display: grid;
    gap: 0.35rem;
  }

  .image-side-item h5 {
    margin: 0;
    font-size: 0.85rem;
    color: var(--color-text);
  }

  #image-view-pane-side .image-side-item img {
    max-height: var(--image-max-height, calc(100vh - 18.5rem));
    width: 100%;
    height: auto;
    object-fit: contain;
  }

  #image-view-pane-diff .image-detail-card img {
    max-height: var(--image-max-height, calc(100vh - 18.5rem));
    width: 100%;
    height: auto;
    object-fit: contain;
  }

  .image-detail-grid.single .image-detail-card img {
    max-height: var(--image-max-height, calc(100vh - 13rem));
    width: 100%;
    height: auto;
    object-fit: contain;
  }

  .image-overlay {
    border: 1px solid var(--diff-border);
    border-radius: 0.5rem;
    padding: 0.75rem;
    background: var(--diff-same-bg);
    display: grid;
    gap: 0.75rem;
  }

  .image-overlay-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.5rem;
  }

  .image-overlay-header h4 {
    margin: 0;
    font-size: 0.95rem;
    color: var(--color-text);
  }

  .image-overlay-header span {
    font-size: 0.85rem;
    color: var(--color-muted);
  }

  .image-overlay-frame {
    position: relative;
    width: 100%;
    max-width: calc(var(--image-max-height, calc(100vh - 18.5rem)) / var(--image-ratio, 1));
    max-height: var(--image-max-height, calc(100vh - 18.5rem));
    margin: 0 auto;
    overflow: hidden;
    background: var(--diff-empty-bg);
    border-radius: 0.25rem;
  }

  .image-overlay-frame::before {
    content: "";
    display: block;
    padding-top: calc(var(--image-ratio, 1) * 100%);
  }

  .image-overlay-frame img {
    position: absolute;
    top: 0;
    left: 0;
    width: auto;
    height: auto;
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
  }

  .image-overlay-frame img.overlay {
    opacity: var(--overlay-opacity, 0.5);
  }

  .image-overlay-controls {
    display: grid;
    grid-template-columns: auto 1fr auto auto auto;
    align-items: center;
    gap: 0.5rem;
    color: var(--color-muted);
    font-size: 0.85rem;
  }

  .image-overlay-controls input[type="range"] {
    width: 100%;
  }

  .image-overlay-controls button {
    border: 1px solid var(--diff-border);
    background: var(--diff-header-bg);
    color: var(--color-text);
    border-radius: 0.25rem;
    padding: 0.25rem 0.5rem;
    cursor: pointer;
    font-size: 0.85rem;
  }

  .image-overlay-controls button:hover {
    filter: brightness(0.98);
  }

  </style>
  <div class="image-detail">
    {% match detail %}
    {% when ImageDetailBody::Diff with { expected, actual, diff } %}
    <div class="image-detail-tabs" data-image-tabs>
      <button type="button" class="image-detail-tab" data-image-view="overlay" aria-selected="true">Slider comparison</button>
      <button type="button" class="image-detail-tab" data-image-view="diff" aria-selected="false">Diff image only</button>
      <button type="button" class="image-detail-tab" data-image-view="side" aria-selected="false">Side-by-side</button>
    </div>
    <div class="image-detail-view active" id="image-view-pane-overlay">
      <div class="image-overlay" data-image-overlay>
        <div class="image-overlay-header">
          <h4>overlay compare</h4>
          <span>{{ expected.width }} × {{ expected.height }}</span>
        </div>
        <div class="image-overlay-frame" style="--image-ratio: {{ diff.height as f64 / diff.width as f64 }};">
          <img src="{{ expected.uri }}" alt="expected image" />
          <img src="{{ actual.uri }}" alt="actual image" class="overlay" />
        </div>
        <div class="image-overlay-controls">
          <span>expected</span>
          <input type="range" min="0" max="100" value="50" class="image-overlay-range" />
          <span>actual</span>
          <button type="button" data-overlay-set="0">expected</button>
          <button type="button" data-overlay-set="100">actual</button>
        </div>
      </div>
    </div>
    <div class="image-detail-view" id="image-view-pane-diff">
      <div class="image-detail-grid single">
        <div class="image-detail-card">
          <div class="image-card-header">
            <h4>diff</h4>
            <span>{{ diff.width }} × {{ diff.height }}</span>
          </div>
          <img src="{{ diff.uri }}" alt="diff image" />
        </div>
      </div>
    </div>
    <style media="(max-aspect-ratio: {{ expected.width * 2 }}/{{ expected.height }})">
      .image-side-compare {
        grid-template-columns: minmax(0, 1fr);
      }
    </style>
    <div class="image-detail-view" id="image-view-pane-side">
      <div class="image-detail-grid side">
        <div class="image-detail-card">
          <div class="image-side-compare">
            <div class="image-side-item">
              <div class="image-card-header">
                <h5>expected</h5>
                <span>{{ expected.width }} × {{ expected.height }}</span>
              </div>
              <img src="{{ expected.uri }}" alt="expected image" />
            </div>
            <div class="image-side-item">
              <div class="image-card-header">
                <h5>actual</h5>
                <span>{{ actual.width }} × {{ actual.height }}</span>
              </div>
              <img src="{{ actual.uri }}" alt="actual image" />
            </div>
          </div>
        </div>
      </div>
    </div>
    {% when ImageDetailBody::Single with { label, image } %}
    <div class="image-detail-grid single">
      <div class="image-detail-card">
        <div class="image-card-header">
          <h4>{{ label }}</h4>
          <span>{{ image.width }} × {{ image.height }}</span>
        </div>
        <img src="{{ image.uri }}" alt="{{ label }} image" />
      </div>
    </div>
    {% endmatch %}
  </div>
<script>
  (() => {
    const tabGroups = document.querySelectorAll('[data-image-tabs]');
    tabGroups.forEach((tabs) => {
      const root = tabs.closest('.image-detail');
      if (!root) {
        return;
      }
      const buttons = tabs.querySelectorAll('[data-image-view]');
      const panes = root.querySelectorAll('[id^="image-view-pane-"]');
      if (buttons.length === 0 || panes.length === 0) {
        return;
      }
      const activate = (view) => {
        buttons.forEach((button) => {
          const selected = button.dataset.imageView === view;
          button.setAttribute('aria-selected', selected ? 'true' : 'false');
        });
        panes.forEach((pane) => {
          pane.classList.toggle('active', pane.id === `image-view-pane-${view}`);
        });
      };
      buttons.forEach((button) => {
        button.addEventListener('click', () => activate(button.dataset.imageView));
      });
      activate(buttons[0].dataset.imageView);
    });

    const overlays = document.querySelectorAll('[data-image-overlay]');
    overlays.forEach((overlay) => {
      const frame = overlay.querySelector('.image-overlay-frame');
      const range = overlay.querySelector('.image-overlay-range');
      const buttons = overlay.querySelectorAll('[data-overlay-set]');
      if (!frame || !range) {
        return;
      }
      const applyValue = (value) => {
        const numeric = Math.min(100, Math.max(0, Number(value)));
        frame.style.setProperty('--overlay-opacity', (numeric / 100).toString());
        range.value = String(numeric);
      };
      range.addEventListener('input', () => applyValue(range.value));
      buttons.forEach((button) => {
        button.addEventListener('click', () => applyValue(button.dataset.overlaySet));
      });
      applyValue(range.value);
    });
  })();
</script>
