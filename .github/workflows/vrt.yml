name: visual regression test

on:
  push:
    branches:
      - main
  pull_request_target:

jobs:
  capture:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v6
        with:
          ref: ${{ github.event_name == 'pull_request_target' && github.event.pull_request.head.sha || github.sha }}

      - id: rust-toolchain
        uses: dtolnay/rust-toolchain@stable

      - uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: ${{ github.event_name == 'pull_request_target' && format('rust-{0}-pr-{1}-cargo-{2}', runner.os, github.event.pull_request.number, hashFiles('Cargo.lock')) || format('rust-{0}-cargo-{1}', runner.os, hashFiles('Cargo.lock')) }}
          restore-keys: |
            ${{ github.event_name == 'pull_request_target' && format('rust-{0}-cargo-{1}', runner.os, hashFiles('Cargo.lock')) }}
            ${{ github.event_name == 'pull_request_target' && format('rust-{0}-pr-{1}-cargo-', runner.os, github.event.pull_request.number) }}
            ${{ github.event_name == 'pull_request_target' && format('rust-{0}-cargo-', runner.os) }}

      - uses: actions/cache@v5
        with:
          path: target
          key: ${{ github.event_name == 'pull_request_target' && format('rust-{0}-pr-{1}-target-vrt-{2}-{3}', runner.os, github.event.pull_request.number, steps.rust-toolchain.outputs.cachekey, hashFiles('Cargo.lock')) || format('rust-{0}-target-vrt-{1}-{2}', runner.os, steps.rust-toolchain.outputs.cachekey, hashFiles('Cargo.lock')) }}
          restore-keys: |
            ${{ github.event_name == 'pull_request_target' && format('rust-{0}-target-vrt-{1}-{2}', runner.os, steps.rust-toolchain.outputs.cachekey, hashFiles('Cargo.lock')) }}
            ${{ github.event_name == 'pull_request_target' && format('rust-{0}-pr-{1}-target-vrt-', runner.os, github.event.pull_request.number) }}
            ${{ github.event_name == 'pull_request_target' && format('rust-{0}-target-vrt-', runner.os) }}

      - run: cargo fetch --locked

      - run: bash ./.github/scripts/capture_vrt_data.sh

      - uses: actions/upload-artifact@v6
        with:
          name: vrt-data
          path: data

  publish_baseline:
    if: github.event_name == 'push' && github.ref_name == github.event.repository.default_branch
    needs: capture
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/download-artifact@v7
        with:
          name: vrt-data
          path: ./actual

      - run: |
          OUT_ROOT="$(pwd)/actual"
          tar -I 'zstd -19' -cf saved.tar.zst -C "${OUT_ROOT}" .

      - uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CF_API_TOKEN }}
          accountId: ${{ secrets.CF_ACCOUNT_ID }}
          command: |
            r2 object put ${{ secrets.VRT_CF_R2_BUCKET }}/visual-regression/saved.tar.zst --file ./saved.tar.zst

  pr_checks:
    if: github.event_name == 'pull_request_target'
    needs: capture
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write
    steps:
      - uses: actions/download-artifact@v7
        with:
          name: vrt-data
          path: ./actual

      - continue-on-error: true
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CF_API_TOKEN }}
          accountId: ${{ secrets.CF_ACCOUNT_ID }}
          command: |
            r2 object get ${{ secrets.VRT_CF_R2_BUCKET }}/visual-regression/saved.tar.zst --file main-saved.tar.zst

      - run: |
          if [ -f main-saved.tar.zst ]; then
            mkdir -p expected
            tar -xaf main-saved.tar.zst -C expected
          fi
          
          LATEST_RELEASE=$(curl -L https://api.github.com/repos/White-Green/semdiff/releases/latest)
          LATEST_RELEASE_DOWNLOAD_URL=$(echo $LATEST_RELEASE | jq -r '.assets | .[] | select(.name | contains("x86_64-unknown-linux")) | .browser_download_url')
          mkdir -p .github/tmp
          curl -L $LATEST_RELEASE_DOWNLOAD_URL --output .github/tmp/semdiff.tar.gz
          tar -xaf .github/tmp/semdiff.tar.gz -C .github/tmp
          .github/tmp/semdiff/semdiff ./expected ./actual --output-html regression/index.html --output-json ./report.json

      - uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CF_API_TOKEN }}
          accountId: ${{ secrets.CF_ACCOUNT_ID }}
          command: |
            pages deploy --project-name ${{ vars.VRT_CF_PAGES_PROJECT_NAME }} --branch pr-${{ github.event.pull_request.number }} ./regression

      - uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const path = './report.json';
            const report = JSON.parse(fs.readFileSync(path, 'utf8'));

            const marker = '<!-- visual-regression-diff-marker -->';

            const body = `${marker}
            ## Visual Regression Test Summary

            | Category  | Count               |
            |-----------|---------------------|
            | Unchanged | ${report.unchanged} |
            | Modified  | ${report.modified}  |
            | Added     | ${report.added}     |
            | Deleted   | ${report.deleted}   |

            [Diff Report](https://pr-${{ github.event.pull_request.number }}.${{ vars.VRT_CF_PAGES_PROJECT_NAME }}.pages.dev/)
            `;

            const { owner, repo } = context.repo;
            const issue_number = context.payload.pull_request.number;

            const { data: comments } = await github.rest.issues.listComments({
              owner,
              repo,
              issue_number,
              per_page: 100,
            });
            const oldComments = comments.filter(comment => comment.body.includes(marker));
            for (const { node_id: nodeId } of oldComments) {
              const mutation = `
                mutation($subjectId: ID!) {
                  minimizeComment(input: {
                    subjectId: $subjectId,
                    classifier: OUTDATED
                  }) {
                    minimizedComment {
                      isMinimized
                      minimizedReason
                    }
                  }
                }
              `;

              await github.graphql(mutation, { subjectId: nodeId });
            }

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number,
              body,
            });
