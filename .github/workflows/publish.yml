name: publish
on:
  workflow_dispatch:

jobs:
  format:
    uses: ./.github/workflows/format.yml

  lint:
    uses: ./.github/workflows/lint.yml

  test:
    uses: ./.github/workflows/test.yml

  build_binary:
    name: Build Binary for ${{ matrix.target }}
    needs: [ format, lint, test ]
    strategy:
      matrix:
        include:
          - os: ubuntu-22.04
            target: x86_64-unknown-linux-musl
            ext: ""
          - os: windows-2022
            target: x86_64-pc-windows-msvc
            ext: ".exe"
          - os: windows-2022
            target: aarch64-pc-windows-msvc
            ext: ".exe"
          - os: macOS-14
            target: aarch64-apple-darwin
            ext: ""
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v6

      - uses: dtolnay/rust-toolchain@stable
        with:
          target: ${{ matrix.target }}

      - if: matrix.target == 'x86_64-unknown-linux-musl'
        run: sudo apt install -y musl-tools

      - run: cargo build --release --locked --target ${{ matrix.target }}

      - id: package
        shell: bash
        run: |
          set -euo pipefail

          ARCHIVE_NAME="semdiff-${{ matrix.target }}.tar.gz"
          mkdir -p dist
          mkdir -p .github/archive/semdiff
          ls target/release
          mv target/release/semdiff${{ matrix.ext }} README.md LICENSE-Apache LICENSE-MIT .github/archive/semdiff
          tar -czf "dist/${ARCHIVE_NAME}" -C .github/archive semdiff
          echo "archive_name=${ARCHIVE_NAME}" >> "$GITHUB_OUTPUT"
          echo "archive_path=dist/${ARCHIVE_NAME}" >> "$GITHUB_OUTPUT"

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.package.outputs.archive_name }}
          path: ${{ steps.package.outputs.archive_path }}
          if-no-files-found: error

  publish:
    if: github.actor == 'White-Green'
    needs: build_binary
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    steps:
      - uses: actions/checkout@v6

      - uses: dtolnay/rust-toolchain@stable

      - uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: ${{ runner.os }}-cargo-${{ hashFiles('Cargo.lock') }}

      - uses: actions/cache@v5
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-${{ hashFiles('Cargo.lock') }}

      - run: cargo fetch --locked

      - uses: actions/download-artifact@v4
        with:
          path: release-artifacts
          merge-multiple: true

      - run: |
          set -euo pipefail
          
          VERSION=$(cargo metadata --format-version 1 | jq -r '.packages[] | select(.name == "semdiff-cli") | .version')
          gh release create --draft "v${VERSION}" --fail-on-no-commits --generate-notes --target ${{ github.event.repository.default_branch }} --title "v${VERSION}" release-artifacts/*
        env:
          GH_TOKEN: ${{ github.token }}

      - id: auth
        uses: rust-lang/crates-io-auth-action@v1

      - run: cargo publish --workspace --dry-run
        env:
          CARGO_REGISTRY_TOKEN: ${{ steps.auth.outputs.token }}
